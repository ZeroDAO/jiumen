import{E as D}from"./key-did-provider-ed25519-f246feaa.js";import{K as v}from"./key-did-resolver-e34e002c.js";import{r as m}from"./@stablelib-7cabded6.js";import{t as p,f as w}from"./uint8arrays-499feafe.js";import{D as b}from"./dids-22529382.js";function x(i,e){if(e.has(i))throw new TypeError("Cannot initialize the same private elements twice on an object")}function E(i,e){return e.get?e.get.call(i):e.value}function T(i,e,t){if(e.set)e.set.call(i,t);else{if(!e.writable)throw new TypeError("attempted to set read only private field");e.value=t}}function S(i,e,t){if(!e.has(i))throw new TypeError("attempted to "+t+" private field on non-instance");return e.get(i)}function n(i,e){var t=S(i,e,"get");return E(i,t)}function l(i,e,t){x(i,e),e.set(i,t)}function f(i,e,t){var r=S(i,e,"set");return T(i,r,t),t}async function y(i){const e=new D(i||m.randomBytes(32)),t=new b({provider:e,resolver:v.getResolver()});return await t.authenticate(),t}async function k(i,e){const t=i.withCapability(e);return await t.authenticate(),t}function I(i){return p(w(JSON.stringify(i)),"base64url")}function K(i){return JSON.parse(p(w(i,"base64url")))}function z(i){return p(i,"base64pad")}function C(i){return w(i,"base64pad")}var o=new WeakMap,h=new WeakMap,a=new WeakMap;class u{static async authorize(e,t={}){if(!t.resources||t.resources.length===0)throw new Error("Required: resource argument option when authorizing");const r=m.randomBytes(32),s=await y(r);if(t.expiresInSecs){const g=new Date(Date.now()+t.expiresInSecs*1e3);t.expirationTime=g.toISOString()}const c=await e.requestCapability(s.id,[],t),d=await k(s,c);return new u({cacao:c,keySeed:r,did:d})}static async initDID(e,t){const r=e.withCapability(t);return await r.authenticate(),r}get did(){return n(this,o)}serialize(){const e={sessionKeySeed:z(n(this,h)),cacao:n(this,a)};return I(e)}static async fromSession(e){const{sessionKeySeed:t,cacao:r}=K(e),s=C(t),c=await y(s),d=await u.initDID(c,r);return new u({cacao:r,keySeed:s,did:d})}get hasSession(){return!!n(this,a)&&!!n(this,o)}get isExpired(){const e=n(this,a).p.exp;return e?Date.parse(e)<Date.now():!1}get expireInSecs(){const e=n(this,a).p.exp;if(!e)throw new Error("Session does not expire");const t=Date.parse(e)-Date.now();return t<0?0:t/1e3}get authorizations(){return n(this,a)?.p.resources??[]}get cacao(){return n(this,a)}isAuthorized(e){return!this.hasSession||this.isExpired?!1:e?e.every(t=>this.authorizations.includes(t)):!0}get id(){return n(this,o).parent}constructor(e){l(this,o,{writable:!0,value:void 0}),l(this,h,{writable:!0,value:void 0}),l(this,a,{writable:!0,value:void 0}),f(this,h,e.keySeed),f(this,a,e.cacao),f(this,o,e.did)}}export{u as D};
