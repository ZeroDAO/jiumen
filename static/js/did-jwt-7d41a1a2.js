import{f as g,t as E,c as D}from"./uint8arrays-1b95a8ae.js";import{f as Ke}from"./multiformats-1a570ced.js";import{r as ue,x as L,s as he,a as ae,e as de}from"./@stablelib-91de8d10.js";import{s as Se}from"./js-sha3-256b6419.js";import{e as j}from"./elliptic-51a3863c.js";import{c as Je}from"./canonicalize-8293648e.js";var W={};Object.defineProperty(W,"__esModule",{value:!0});W.bech32m=I=W.bech32=void 0;const T="qpzry9x8gf2tvdw0s3jn54khce6mua7l",ye={};for(let e=0;e<T.length;e++){const t=T.charAt(e);ye[t]=e}function S(e){const t=e>>25;return(e&33554431)<<5^-(t>>0&1)&996825010^-(t>>1&1)&642813549^-(t>>2&1)&513874426^-(t>>3&1)&1027748829^-(t>>4&1)&705979059}function Y(e){let t=1;for(let n=0;n<e.length;++n){const o=e.charCodeAt(n);if(o<33||o>126)return"Invalid prefix ("+e+")";t=S(t)^o>>5}t=S(t);for(let n=0;n<e.length;++n){const o=e.charCodeAt(n);t=S(t)^o&31}return t}function q(e,t,n,o){let r=0,i=0;const c=(1<<n)-1,s=[];for(let f=0;f<e.length;++f)for(r=r<<t|e[f],i+=t;i>=n;)i-=n,s.push(r>>i&c);if(o)i>0&&s.push(r<<n-i&c);else{if(i>=t)return"Excess padding";if(r<<n-i&c)return"Non-zero padding"}return s}function Oe(e){return q(e,8,5,!0)}function Be(e){const t=q(e,5,8,!1);if(Array.isArray(t))return t}function $e(e){const t=q(e,5,8,!1);if(Array.isArray(t))return t;throw new Error(t)}function be(e){let t;e==="bech32"?t=1:t=734539939;function n(c,s,f){if(f=f||90,c.length+7+s.length>f)throw new TypeError("Exceeds length limit");c=c.toLowerCase();let u=Y(c);if(typeof u=="string")throw new Error(u);let a=c+"1";for(let l=0;l<s.length;++l){const d=s[l];if(d>>5!==0)throw new Error("Non 5-bit word");u=S(u)^d,a+=T.charAt(d)}for(let l=0;l<6;++l)u=S(u);u^=t;for(let l=0;l<6;++l){const d=u>>(5-l)*5&31;a+=T.charAt(d)}return a}function o(c,s){if(s=s||90,c.length<8)return c+" too short";if(c.length>s)return"Exceeds length limit";const f=c.toLowerCase(),u=c.toUpperCase();if(c!==f&&c!==u)return"Mixed-case string "+c;c=f;const a=c.lastIndexOf("1");if(a===-1)return"No separator character for "+c;if(a===0)return"Missing prefix for "+c;const l=c.slice(0,a),d=c.slice(a+1);if(d.length<6)return"Data too short";let y=Y(l);if(typeof y=="string")return y;const v=[];for(let h=0;h<d.length;++h){const p=d.charAt(h),m=ye[p];if(m===void 0)return"Unknown character "+p;y=S(y)^m,!(h+6>=d.length)&&v.push(m)}return y!==t?"Invalid checksum for "+c:{prefix:l,words:v}}function r(c,s){const f=o(c,s);if(typeof f=="object")return f}function i(c,s){const f=o(c,s);if(typeof f=="object")return f;throw new Error(f)}return{decodeUnsafe:r,decode:i,encode:n,toWords:Oe,fromWordsUnsafe:Be,fromWords:$e}}var I=W.bech32=be("bech32");W.bech32m=be("bech32m");function w(e){return E(e,"base64url")}function _(e){const t=e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"");return g(t,"base64url")}function G(e){return g(e,"base58btc")}function Ue(e){return E(e,"base58btc")}function X(e){const t=e.startsWith("0x")?e.substring(2):e;return g(t.toLowerCase(),"base16")}function F(e){return w(g(e))}function ge(e){return E(_(e))}function x(e){return E(e,"base16")}function pe(e){return g(e)}function me({r:e,s:t,recoveryParam:n},o){const r=new Uint8Array(o?65:64);if(r.set(g(e,"base16"),0),r.set(g(t,"base16"),32),o){if(typeof n>"u")throw new Error("Signer did not return a recoveryParam");r[64]=n}return w(r)}function Ce(e){const t=_(e);if(t.length<64||t.length>65)throw new TypeError(`Wrong size for signature. Expected 64 or 65 bytes, but got ${t.length}`);const n=x(t.slice(0,32)),o=x(t.slice(32,64)),r=t.length===65?t[64]:void 0;return{r:n,s:o,recoveryParam:r}}function _e(e,t){return D([_(e),_(t)])}function k(e){const t=typeof e=="string"?g(e):e;return he.hash(t)}function We(e){return new Uint8Array(Se.keccak_256.arrayBuffer(e))}function ve(e){const t=g(e.slice(2),"base16");return`0x${E(We(t).slice(-20),"base16")}`}function Z(e,t=new Uint8Array(4)){const n=g(e.toString(),"base10");return t.set(n,4-n.length),t}const N=e=>D([Z(e.length),e]);function we(e,t,n,o,r){if(t!==256)throw new Error(`Unsupported key length: ${t}`);const i=D([N(g(n)),N(typeof o>"u"?new Uint8Array(0):o),N(typeof r>"u"?new Uint8Array(0):r),Z(t)]),c=1;return he.hash(D([Z(c),e,i]))}new j.ec("secp256k1");function ft(e){const t=e;if(t.length!==64)throw new Error(`bad_key: Invalid private key format. Expecting 64 bytes, but got ${t.length}`);return function(n){try{const o=typeof n=="string"?pe(n):n,r=de.sign(t,o);return Promise.resolve(w(r))}catch(o){return Promise.reject(o)}}}new j.ec("p256");function M(e){return typeof e=="object"&&"r"in e&&"s"in e}function ze(){return function(t,n){try{return Promise.resolve(n(t)).then(function(o){return M(o)?me(o):o})}catch(o){return Promise.reject(o)}}}function R(e){return function(n,o){try{return Promise.resolve(o(n)).then(function(r){if(M(r))return me(r,e);if(e&&typeof Ce(r).recoveryParam>"u")throw new Error("not_supported: ES256K-R not supported when signer doesn't provide a recovery param");return r})}catch(r){return Promise.reject(r)}}}function V(){return function(t,n){try{return Promise.resolve(n(t)).then(function(o){if(M(o))throw new Error("invalid_config: expected a signer function that returns a string instead of signature object");return o})}catch(o){return Promise.reject(o)}}}const je={ES256:ze(),ES256K:R(),"ES256K-R":R(!0),Ed25519:V(),EdDSA:V()};function De(e){const t=je[e];if(!t)throw new Error(`not_supported: Unsupported algorithm ${e}`);return t}const J=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13],O=[5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11],B=[11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6],$=[8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11],U=[0,1518500249,1859775393,2400959708,2840853838],C=[1352829926,1548603684,1836072691,2053994217,0];function A(e,t){return e<<t|e>>>32-t}function ee(e,t,n,o,r,i,c,s){return A(e+(t^n^o)+i+c|0,s)+r|0}function te(e,t,n,o,r,i,c,s){return A(e+(t&n|~t&o)+i+c|0,s)+r|0}function ne(e,t,n,o,r,i,c,s){return A(e+((t|~n)^o)+i+c|0,s)+r|0}function re(e,t,n,o,r,i,c,s){return A(e+(t&o|n&~o)+i+c|0,s)+r|0}function oe(e,t,n,o,r,i,c,s){return A(e+(t^(n|~o))+i+c|0,s)+r|0}class xe{constructor(t=64){this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this._blockOffset=0,this._block=void 0,this._blockSize=void 0,this._length=[0,0,0,0],this._finalized=void 0,this.update=n=>{if(this._finalized)throw new Error("Digest already called");const o=this._block;let r=0;for(;this._blockOffset+n.length-r>=this._blockSize;){for(let i=this._blockOffset;i<this._blockSize;)o[i++]=n[r++];this._update(),this._blockOffset=0}for(;r<n.length;)o[this._blockOffset++]=n[r++];for(let i=0,c=n.length*8;c>0;++i)this._length[i]+=c,c=this._length[i]/4294967296|0,c>0&&(this._length[i]-=4294967296*c);return this},this.digest=()=>{if(this._finalized)throw new Error("Digest already called");this._finalized=!0;const n=this._digest();this._block.fill(0),this._blockOffset=0;for(let o=0;o<4;++o)this._length[o]=0;return n},this._update=()=>{const n=new Array(16),o=new DataView(this._block.buffer);for(let h=0;h<16;++h)n[h]=n[h]=o.getInt32(h*4,!0);let r=this._a|0,i=this._b|0,c=this._c|0,s=this._d|0,f=this._e|0,u=this._a|0,a=this._b|0,l=this._c|0,d=this._d|0,y=this._e|0;for(let h=0;h<80;h+=1){let p,m;h<16?(p=ee(r,i,c,s,f,n[J[h]],U[0],B[h]),m=oe(u,a,l,d,y,n[O[h]],C[0],$[h])):h<32?(p=te(r,i,c,s,f,n[J[h]],U[1],B[h]),m=re(u,a,l,d,y,n[O[h]],C[1],$[h])):h<48?(p=ne(r,i,c,s,f,n[J[h]],U[2],B[h]),m=ne(u,a,l,d,y,n[O[h]],C[2],$[h])):h<64?(p=re(r,i,c,s,f,n[J[h]],U[3],B[h]),m=te(u,a,l,d,y,n[O[h]],C[3],$[h])):(p=oe(r,i,c,s,f,n[J[h]],U[4],B[h]),m=ee(u,a,l,d,y,n[O[h]],C[4],$[h])),r=f,f=s,s=A(c,10),c=i,i=p,u=y,y=d,d=A(l,10),l=a,a=m}const v=this._b+c+d|0;this._b=this._c+s+y|0,this._c=this._d+f+u|0,this._d=this._e+r+a|0,this._e=this._a+i+l|0,this._a=v},this._digest=()=>{this._block[this._blockOffset++]=128,this._blockOffset>56&&(this._block.fill(0,this._blockOffset,64),this._update(),this._blockOffset=0),this._block.fill(0,this._blockOffset,56);const n=new DataView(this._block.buffer);n.setUint32(56,this._length[0],!0),n.setUint32(60,this._length[1],!0),this._block=new Uint8Array(n.buffer),this._update();const o=new DataView(new Uint8Array(20).buffer);return o.setInt32(0,this._a,!0),o.setInt32(4,this._b,!0),o.setInt32(8,this._c,!0),o.setInt32(12,this._d,!0),o.setInt32(16,this._e,!0),new Uint8Array(o.buffer)},this._block=new Uint8Array(t),this._blockSize=t,this._blockOffset=0,this._length=[0,0,0,0],this._finalized=!1}}const Te=(e,t)=>{const n=E(G(t).slice(0,1),"hex"),o=g(e,"hex"),r=new xe().update(k(o)).digest(),i=n+E(r,"hex"),c=k(g(i,"hex")),s=k(c),f=E(s,"hex").substring(0,8),u=i+f;return Ue(g(u,"hex"))},He=j.ec,Xe=(e,t)=>{const o=new He("secp256k1").keyFromPublic(e,"hex").getPublic().encode("hex",!0),r=g(o,"hex"),i=new xe().update(k(r)).digest(),c=I.toWords(i);return I.encode(t,c).replace(t,"")},Ne=(e,t)=>{if(t){const n=t.split(":");switch(n[0]){case"bip122":n[n.length-1]=Te(e,n[n.length-1]);break;case"cosmos":n[n.length-1]=Xe(e,n[1]);break;case"eip155":n[n.length-1]=ve(e);break;default:return!1}return n.join(":").toLowerCase()===t.toLowerCase()}return!1},Q=new j.ec("secp256k1"),Pe=new j.ec("p256");function z(e,t=!1){const n=_(e);if(n.length!==(t?65:64))throw new Error("wrong signature length");const o=x(n.slice(0,32)),r=x(n.slice(32,64)),i={r:o,s:r};return t&&(i.recoveryParam=n[64]),i}function H(e){if(e.publicKeyBase58)return G(e.publicKeyBase58);if(e.publicKeyBase64)return _(e.publicKeyBase64);if(e.publicKeyHex)return X(e.publicKeyHex);if(e.publicKeyJwk&&e.publicKeyJwk.crv==="secp256k1"&&e.publicKeyJwk.x&&e.publicKeyJwk.y)return X(Q.keyFromPublic({x:x(_(e.publicKeyJwk.x)),y:x(_(e.publicKeyJwk.y))}).getPublic("hex"));if(e.publicKeyJwk&&e.publicKeyJwk.crv==="P-256"&&e.publicKeyJwk.x&&e.publicKeyJwk.y)return X(Pe.keyFromPublic({x:x(_(e.publicKeyJwk.x)),y:x(_(e.publicKeyJwk.y))}).getPublic("hex"));if(e.publicKeyJwk&&e.publicKeyJwk.kty==="OKP"&&e.publicKeyJwk.crv==="Ed25519"&&e.publicKeyJwk.x)return _(e.publicKeyJwk.x);if(e.publicKeyMultibase){const{base16:t,base58btc:n,base64:o,base64url:r}=Ke;return t.decoder.or(n.decoder.or(o.decoder.or(r.decoder))).decode(e.publicKeyMultibase)}return new Uint8Array}function Le(e,t,n){const o=k(e),r=z(t),c=n.filter(({ethereumAddress:s,blockchainAccountId:f})=>typeof s>"u"&&typeof f>"u").find(s=>{try{const f=H(s);return Pe.keyFromPublic(f).verify(o,r)}catch{return!1}});if(!c)throw new Error("invalid_signature: Signature invalid for JWT");return c}function Ie(e,t,n){const o=k(e),r=z(t),i=n.filter(({ethereumAddress:f,blockchainAccountId:u})=>typeof f>"u"&&typeof u>"u"),c=n.filter(({ethereumAddress:f,blockchainAccountId:u})=>typeof f<"u"||typeof u<"u");let s=i.find(f=>{try{const u=H(f);return Q.keyFromPublic(u).verify(o,r)}catch{return!1}});if(!s&&c.length>0&&(s=Ee(e,t,c)),!s)throw new Error("invalid_signature: Signature invalid for JWT");return s}function Ee(e,t,n){let o;if(t.length>86)o=[z(t,!0)];else{const c=z(t,!1);o=[{...c,recoveryParam:0},{...c,recoveryParam:1}]}const r=c=>{const s=k(e),f=Q.recoverPubKey(s,c,c.recoveryParam),u=f.encode("hex"),a=f.encode("hex",!0),l=ve(u).toLowerCase();return n.find(y=>{var v,h,p;const m=x(H(y));return m===u||m===a||((v=y.ethereumAddress)==null?void 0:v.toLowerCase())===l||((h=y.blockchainAccountId)==null||(p=h.split("@eip155"))==null?void 0:p[0].toLowerCase())===l||Ne(u,y.blockchainAccountId)})},i=o.map(r).filter(c=>typeof c<"u");if(i.length===0)throw new Error("invalid_signature: Signature invalid for JWT");return i[0]}function ie(e,t,n){const o=pe(e),r=_(t),i=n.find(c=>de.verify(H(c),o,r));if(!i)throw new Error("invalid_signature: Signature invalid for JWT");return i}const Fe={ES256:Le,ES256K:Ie,"ES256K-R":Ee,Ed25519:ie,EdDSA:ie};function ke(e){const t=Fe[e];if(!t)throw new Error(`not_supported: Unsupported algorithm ${e}`);return t}ke.toSignatureObject=z;const lt=function(e,t,n={},o={}){try{n.alg||(n.alg=Ze);const r=typeof e=="string"?e:ce(e,o.canonicalize),i=[ce(n,o.canonicalize),r].join("."),c=De(n.alg);return Promise.resolve(c(i,t)).then(function(s){return[i,s].join(".")})}catch(r){return Promise.reject(r)}},Ze="ES256K";function ce(e,t=!1){return F(t?Je(e):JSON.stringify(e))}function qe(e){const t=e.match(/^([a-zA-Z0-9_-]+)\.([a-zA-Z0-9_-]+)\.([a-zA-Z0-9_-]+)$/);if(t)return{header:JSON.parse(ge(t[1])),payload:t[2],signature:t[3],data:`${t[1]}.${t[2]}`};throw new Error("invalid_argument: Incorrect format JWS")}function Ge({header:e,data:t,signature:n},o){return Array.isArray(o)||(o=[o]),ke(e.alg)(t,n,o)}function ut(e,t){const n=qe(e);return Ge(n,t)}const se=typeof Symbol<"u"?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function b(e,t,n){if(!e.s){if(n instanceof K)if(n.s)t&1&&(t=n.s),n=n.v;else{n.o=b.bind(null,e,t);return}if(n&&n.then){n.then(b.bind(null,e,t),b.bind(null,e,2));return}e.s=t,e.v=n;const o=e.o;o&&o(e)}}const K=function(){function e(){}return e.prototype.then=function(t,n){const o=new e,r=this.s;if(r){const i=r&1?t:n;if(i){try{b(o,1,i(this.v))}catch(c){b(o,2,c)}return o}else return this}return this.o=function(i){try{const c=i.v;i.s&1?b(o,1,t?t(c):c):n?b(o,1,n(c)):b(o,2,c)}catch(c){b(o,2,c)}},o},e}();function P(e){return e instanceof K&&e.s&1}function Me(e,t,n){var o=-1,r,i;function c(s){try{for(;++o<e.length&&(!n||!n());)if(s=t(o),s&&s.then)if(P(s))s=s.v;else{s.then(c,i||(i=b.bind(null,r=new K,2)));return}r?b(r,1,s):r=s}catch(f){b(r||(r=new K),2,f)}}return c(),r}function Qe(e,t,n){if(typeof e[se]=="function"){let a=function(l){try{for(;!(r=o.next()).done&&(!n||!n());)if(l=t(r.value),l&&l.then)if(P(l))l=l.v;else{l.then(a,c||(c=b.bind(null,i=new K,2)));return}i?b(i,1,l):i=l}catch(d){b(i||(i=new K),2,d)}};var o=e[se](),r,i,c;if(a(),o.return){var s=function(l){try{r.done||o.return()}catch{}return l};if(i&&i.then)return i.then(s,function(l){throw s(l)});s()}return i}if(!("length"in e))throw new TypeError("Object is not iterable");for(var f=[],u=0;u<e.length;u++)f.push(e[u]);return Me(f,function(a){return t(f[a])},n)}function Ye(e,t,n){for(var o;;){var r=e();if(P(r)&&(r=r.v),!r)return i;if(r.then){o=0;break}var i=n();if(i&&i.then)if(P(i))i=i.s;else{o=1;break}if(t){var c=t();if(c&&c.then&&!P(c)){o=2;break}}}var s=new K,f=b.bind(null,s,2);return(o===0?r.then(a):o===1?i.then(u):c.then(l)).then(void 0,f),s;function u(d){i=d;do{if(t&&(c=t(),c&&c.then&&!P(c))){c.then(l).then(void 0,f);return}if(r=e(),!r||P(r)&&!r.v){b(s,1,i);return}if(r.then){r.then(a).then(void 0,f);return}i=n(),P(i)&&(i=i.v)}while(!i||!i.then);i.then(u).then(void 0,f)}function a(d){d?(i=n(),i&&i.then?i.then(u).then(void 0,f):u(i)):b(s,1,i)}function l(){(r=e())?r.then?r.then(a).then(void 0,f):a(r):b(s,1,i)}}function Re(e){if(!(e.protected&&e.iv&&e.ciphertext&&e.tag))throw new Error("bad_jwe: missing properties");e.recipients&&e.recipients.map(t=>{if(!(t.header&&t.encrypted_key))throw new Error("bad_jwe: malformed recipients")})}function fe({ciphertext:e,tag:t,iv:n,protectedHeader:o,recipient:r},i){const c={protected:o,iv:w(n),ciphertext:w(e),tag:w(t)};return i&&(c.aad=w(i)),r&&(c.recipients=[r]),c}const ht=function(e,t){try{let o=function(u){if(s===null)throw new Error("failure: Failed to decrypt");return s},n;Re(e);const r=JSON.parse(ge(e.protected));if(r.enc!==t.enc)throw new Error(`not_supported: Decrypter does not supported: '${r.enc}'`);const i=_e(e.ciphertext,e.tag),c=g(e.aad?`${e.protected}.${e.aad}`:e.protected);let s=null;const f=function(){return r.alg==="dir"&&t.alg==="dir"?Promise.resolve(t.decrypt(i,_(e.iv),c)).then(function(u){s=u}):function(){if(!e.recipients||e.recipients.length===0)throw new Error("bad_jwe: missing recipients");{let u=0;return Ye(function(){return!s&&u<e.recipients.length},function(){return u++},function(){const a=e.recipients[u];Object.assign(a.header,r);const l=function(){if(a.header.alg===t.alg)return Promise.resolve(t.decrypt(i,_(e.iv),c,a)).then(function(d){s=d})}();if(l&&l.then)return l.then(function(){})})}}()}();return Promise.resolve(f&&f.then?f.then(o):o(f))}catch(n){return Promise.reject(n)}},at=function(e,t,n={},o){try{if(t[0].alg==="dir"){if(t.length>1)throw new Error('not_supported: Can only do "dir" encryption to one key.');return Promise.resolve(t[0].encrypt(e,n,o)).then(function(r){return fe(r,o)})}else{const r=t[0].enc;if(!t.reduce((f,u)=>f&&u.enc===r,!0))throw new Error("invalid_argument: Incompatible encrypters passed");let i,c;const s=Qe(t,function(f){const u=function(){return i?Promise.resolve(f.encryptCek==null?void 0:f.encryptCek(i)).then(function(a){if(a){var l,d;(l=c)==null||(d=l.recipients)==null||d.push(a)}}):Promise.resolve(f.encrypt(e,n,o)).then(function(a){i=a.cek,c=fe(a,o)})}();if(u&&u.then)return u.then(function(){})});return Promise.resolve(s&&s.then?s.then(function(){return c}):c)}}catch(r){return Promise.reject(r)}},dt=function(e,t){try{const n=function(r,i=[]){try{return Promise.resolve(t.resolve(r)).then(function({didResolutionMetadata:c,didDocument:s}){function f(){var l,d;const y=(l=s.keyAgreement)==null||(d=l.map(h=>typeof h=="string"?[...s.publicKey||[],...s.verificationMethod||[]].find(p=>p.id===h):h))==null?void 0:d.filter(h=>typeof h<"u"),v=y?.filter(h=>h.type==="X25519KeyAgreementKey2019"&&Boolean(h.publicKeyBase58))||[];if(!v.length&&!u.length)throw new Error(`no_suitable_keys: Could not find x25519 key for ${r}`);return v.map(h=>et(G(h.publicKeyBase58),h.id)).concat(...u)}if(i.push(r),c!=null&&c.error||s==null)throw new Error(`resolver_error: Could not resolve ${r}: ${c.error}, ${c.message}`);let u=[];if(!s.controller&&!s.keyAgreement)throw new Error(`no_suitable_keys: Could not find x25519 key for ${r}`);const a=function(){if(s.controller){let l=Array.isArray(s.controller)?s.controller:[s.controller];l=l.filter(y=>!i.includes(y));const d=l.map(y=>n(y,i).catch(()=>[]));return Promise.resolve(Promise.all(d)).then(function(y){u=[].concat(...y)})}}();return a&&a.then?a.then(f):f(a)})}catch(c){return Promise.reject(c)}},o=e.map(r=>n(r));return Promise.resolve(Promise.all(o)).then(function(r){return[].concat(...r)})}catch(n){return Promise.reject(n)}};function Ae(e){const t=new ae.XChaCha20Poly1305(e);return(n,o)=>{const r=ue.randomBytes(t.nonceLength),i=t.seal(r,n,o);return{ciphertext:i.subarray(0,i.length-t.tagLength),tag:i.subarray(i.length-t.tagLength),iv:r}}}function Ve(e){const t=function(i,c={},s){try{const f=F(JSON.stringify(Object.assign({alg:r},c,{enc:o}))),u=g(s?`${f}.${w(s)}`:f);return Promise.resolve({...n(i,u),protectedHeader:f})}catch(f){return Promise.reject(f)}},n=Ae(e),o="XC20P",r="dir";return{alg:r,enc:o,encrypt:t}}function le(e){const t=function(o,r,i){try{return Promise.resolve(n.open(r,o,i))}catch(c){return Promise.reject(c)}},n=new ae.XChaCha20Poly1305(e);return{alg:"dir",enc:"XC20P",decrypt:t}}function et(e,t){const n=function(s,f={},u){try{Object.assign(f,{alg:void 0});const a=ue.randomBytes(32);return Promise.resolve(Ve(a).encrypt(s,f,u)).then(function(l){return Promise.resolve(o(a)).then(function(d){return{...l,recipient:d,cek:a}})})}catch(a){return Promise.reject(a)}},o=function(s){try{const f=L.generateKeyPair(),u=L.sharedKey(f.secretKey,e),a=we(u,i,r),l=Ae(a)(s),d={encrypted_key:w(l.ciphertext),header:{alg:r,iv:w(l.iv),tag:w(l.tag),epk:{kty:"OKP",crv:c,x:w(f.publicKey)}}};return t&&(d.header.kid=t),Promise.resolve(d)}catch(f){return Promise.reject(f)}},r="ECDH-ES+XC20PKW",c="X25519";return{alg:r,enc:"XC20P",encrypt:n,encryptCek:o}}function tt(e){if(!(e&&e.epk&&e.iv&&e.tag))throw new Error("bad_jwe: malformed header")}function yt(e){const t=function(i,c,s,f){try{let l=function(){const h=we(y,o,n),p=_e(f.encrypted_key,f.header.tag);return Promise.resolve(le(h).decrypt(p,_(f.header.iv))).then(function(m){return m===null?null:le(m).decrypt(i,c,s)})};var u,a;if(tt((u=f)==null?void 0:u.header),f=f,((a=f.header.epk)==null?void 0:a.crv)!==r||typeof f.header.epk.x>"u")return Promise.resolve(null);const d=_(f.header.epk.x);let y;const v=function(){if(e instanceof Uint8Array)y=L.sharedKey(e,d);else return Promise.resolve(e(d)).then(function(h){y=h})}();return Promise.resolve(v&&v.then?v.then(l):l(v))}catch(l){return Promise.reject(l)}},n="ECDH-ES+XC20PKW",r="X25519";return{alg:n,enc:"XC20P",decrypt:t}}export{ft as E,lt as a,at as c,ht as d,dt as r,ut as v,yt as x};
